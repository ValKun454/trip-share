<mat-toolbar color="primary" class="toolbar">
  <button mat-icon-button aria-label="back" (click)="goBack()">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <span class="title">{{ trip?.name || 'Trip Details' }}</span>
  <span class="spacer"></span>
  <button mat-icon-button color="accent" matTooltip="Edit trip" (click)="editTrip()">
    <mat-icon>edit</mat-icon>
  </button>
  <button mat-icon-button color="warn" matTooltip="Delete trip" (click)="deleteTrip()">
    <mat-icon>delete</mat-icon>
  </button>
  <button mat-flat-button color="accent" (click)="toggleAddExpense()" *ngIf="!showAddExpense">
    <mat-icon>add</mat-icon>
    Add Expense
  </button>
</mat-toolbar>

<section class="content">
  <div *ngIf="loading" class="loading">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  </div>

  <div *ngIf="error && !loading" class="error">
    <p>{{ error }}</p>
    <button mat-stroked-button (click)="goBack()">Back to Trips</button>
  </div>

  <div *ngIf="trip && !loading" class="trip-details">
    <!-- Trip Info Card -->
    <mat-card class="trip-info">
      <mat-card-header>
        <div mat-card-avatar class="avatar">{{ trip.name.charAt(0).toUpperCase() }}</div>
        <mat-card-title>{{ trip.name }}</mat-card-title>
        <mat-card-subtitle>{{ trip.dates }}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="info-row">
          <span class="label">Created:</span>
          <span class="value">{{ trip.createdAt | date: 'medium' }}</span>
        </div>
        <div class="info-row">
          <span class="label">Participants:</span>
          <span class="value">{{ trip.participants.length }}</span>
        </div>
        <div class="info-row" *ngIf="trip.description">
          <span class="label">Description:</span>
          <span class="value">{{ trip.description }}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Invite friends -->
    <mat-card class="invite-card">
      <mat-card-header>
        <mat-card-title>Invite friends</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="inviteForm" (ngSubmit)="sendInvites()">
          <!-- friends dropdown (always visible) -->
          <div *ngIf="friendsInviteLoading" class="friends-loading">
            Loading friends...
          </div>
          <div *ngIf="friendsInviteError" class="friends-error">
            {{ friendsInviteError }}
          </div>

          <div
            *ngIf="!friendsInviteLoading && !friendsInviteError && friendsForInvite.length"
            class="friends-dropdown"
          >
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>SELECT FRIENDS</mat-label>
              <mat-select
                [value]="selectedInviteFriendIds"
                (selectionChange)="onFriendSelectionChange($event.value)"
                (openedChange)="onDropdownOpenChange($event)"
                panelClass="friends-select-panel"
                multiple
              >
                <mat-option *ngFor="let f of friendsForInvite" [value]="f.id">
                  <span class="dropdown-friend-avatar">{{ f.label.charAt(0) }}</span>
                  {{ f.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div
            *ngIf="!friendsInviteLoading && !friendsInviteError && !friendsForInvite.length"
            class="friends-empty"
          >
            All of your friends are already in this trip.
          </div>

          <div class="invite-actions">
            <button mat-flat-button color="accent" type="submit">
              Send invite
            </button>
          </div>
        </form>

        <!-- invite messages -->
        <div class="success-message" *ngIf="inviteSuccessMessage">
          <mat-icon>check_circle</mat-icon>
          <span>{{ inviteSuccessMessage }}</span>
        </div>
        <div class="error-message" *ngIf="inviteErrorMessage">
          <mat-icon>error</mat-icon>
          <span>{{ inviteErrorMessage }}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Add Expense Form -->
    <mat-card class="add-expense" *ngIf="showAddExpense">
      <mat-card-content>
        <form [formGroup]="expenseForm" (ngSubmit)="editingExpense ? saveExpense() : addExpense()">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Expense Name</mat-label>
            <input matInput formControlName="name" />
            <mat-error *ngIf="expenseForm.get('name')?.hasError('required')">
              Name is required
            </mat-error>
            <mat-error *ngIf="expenseForm.get('name')?.hasError('minlength')">
              Minimum 2 characters
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description (optional)</mat-label>
            <textarea matInput formControlName="description" rows="2"></textarea>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Amount (PLN)</mat-label>
            <input matInput formControlName="totalCost" type="number" step="0.01" />
            <mat-error *ngIf="expenseForm.get('totalCost')?.hasError('required')">
              Amount is required
            </mat-error>
            <mat-error *ngIf="expenseForm.get('totalCost')?.hasError('min')">
              Amount must be greater than 0
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Paid by</mat-label>
            <mat-select
              formControlName="payerId"
              panelClass="friends-select-panel">
              <mat-option *ngFor="let p of payerOptions" [value]="p.id">
                <span class="dropdown-friend-avatar">
                  {{ p.label.charAt(0) }}
                </span>
                {{ p.label }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="expenseForm.get('payerId')?.hasError('required')">
              Payer is required
            </mat-error>
          </mat-form-field>

          <div class="checkbox-row">
            <mat-checkbox formControlName="isScanned">Is Scanned Receipt</mat-checkbox>
            <mat-checkbox formControlName="isEvenDivision">Split Evenly</mat-checkbox>
          </div>

          <!-- Participant Shares Section (shown when Split Evenly is unchecked) -->
          <div *ngIf="!expenseForm.get('isEvenDivision')?.value" class="participant-shares">
            <h4 class="participant-shares__title">Assign participants and amounts</h4>
            
            <div formArrayName="participantShares" class="participant-list">
              <div *ngFor="let share of participantSharesArray.controls; let i = index" 
                   [formGroupName]="i" 
                   class="participant-item">
                <mat-checkbox 
                  formControlName="selected"
                  (change)="onParticipantToggle(i)"
                  class="participant-checkbox">
                  <span class="participant-name">{{ share.get('userName')?.value }}</span>
                </mat-checkbox>
                
                <mat-form-field 
                  appearance="outline" 
                  class="participant-amount"
                  *ngIf="share.get('selected')?.value">
                  <mat-label>Amount (PLN)</mat-label>
                  <input 
                    matInput 
                    type="number" 
                    step="0.01" 
                    formControlName="amount"
                    (input)="onAmountChange()" />
                </mat-form-field>
              </div>
            </div>

            <div *ngIf="amountMismatchError" class="amount-error">
              <mat-icon>warning</mat-icon>
              <span>{{ amountMismatchError }}</span>
            </div>
          </div>

          <div class="form-actions">
            <button mat-stroked-button type="button" (click)="toggleAddExpense()">Cancel</button>
            <button mat-flat-button color="primary" type="submit" [disabled]="expenseForm.invalid">
              {{ editingExpense ? 'Update Expense' : 'Add Expense' }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Expenses List -->
    <div class="expenses-section">
      <h3>Expenses ({{ expenses.length }})</h3>

      <div class="empty" *ngIf="expenses.length === 0">
        <mat-icon>receipt_long</mat-icon>
        <p>No expenses yet. Add your first expense!</p>
      </div>

      <div *ngFor="let exp of expenses" class="expense-card">
        <div class="expense-avatar">{{ exp.name.charAt(0).toUpperCase() }}</div>
        <div class="expense-name">
          {{ exp.name }}
          <span *ngIf="exp.isScanned" class="badge">ðŸ“¸</span>
        </div>
        <div class="expense-amount">{{ formatCurrency(exp.totalCost) }}</div>
        <div class="expense-meta">{{ getPayerDisplayName(exp) }}</div>
        <div class="expense-meta">{{ exp.createdAt | date: 'M/d/yy, h:mm a' }}</div>
        <div class="expense-actions">
          <button
            mat-icon-button
            aria-label="edit"
            (click)="editExpense(exp)"
            matTooltip="Edit expense"
          >
            <mat-icon>edit</mat-icon>
          </button>
          <button
            mat-icon-button
            color="warn"
            aria-label="delete"
            (click)="deleteExpense(exp.id)"
            matTooltip="Delete expense"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
