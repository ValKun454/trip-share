<section class="wrap" *ngIf="!loading; else loader">
  <ng-container *ngIf="data.length; else empty">
    <!-- SUMMARY VIEW -->
    <ng-container *ngIf="!selectedTrip; else detailsView">
      <div class="content">
        <header class="page-header">
          <h1>Total expenses</h1>
          <p>
            Quick overview of what you owe and what others owe you across all
            trips.
          </p>
        </header>

        <div class="grid">
          <mat-card
            class="trip trip--clickable"
            *ngFor="let s of data"
            (click)="selectTrip(s)"
          >
            <mat-card-title class="trip__title">
              <div class="trip__title-left">
                <mat-icon>travel_explore</mat-icon>
                <span class="trip__name">{{ s.trip.name }}</span>
              </div>
            </mat-card-title>

            <div class="trip__totals">
              <div class="kpi">
                <div class="kpi__label">You owe</div>
                <div
                  class="kpi__value"
                  [ngClass]="{ negative: s.totalYouOwe > 0 }"
                >
                  {{
                    s.totalYouOwe
                      | currency : 'PLN' : 'symbol' : '1.2-2'
                  }}
                </div>
              </div>
              <div class="kpi">
                <div class="kpi__label">Owed to you</div>
                <div
                  class="kpi__value"
                  [ngClass]="{ positive: s.totalOwedToYou > 0 }"
                >
                  {{
                    s.totalOwedToYou
                      | currency : 'PLN' : 'symbol' : '1.2-2'
                  }}
                </div>
              </div>
            </div>
          </mat-card>
        </div>
      </div>
    </ng-container>

    <!-- DETAILS VIEW -->
    <ng-template #detailsView>
      <div class="content details">
        <button class="back-btn" type="button" (click)="backToSummary()">
          <span class="back-btn__icon">←</span>
          <span>Back to all trips</span>
        </button>

        <header class="page-header">
          <h1>{{ selectedTrip?.trip?.name }}</h1>
          <p>Detailed balances for this trip.</p>
        </header>

        <mat-card class="trip-details">
          <mat-card-title class="trip__title">
            <div class="trip__title-left">
              <mat-icon>travel_explore</mat-icon>
              <span class="trip__name">{{ selectedTrip?.trip?.name }}</span>
            </div>
          </mat-card-title>

          <div class="trip__totals">
            <div class="kpi">
              <div class="kpi__label">You owe</div>
              <div
                class="kpi__value"
                [ngClass]="{
                  negative: (selectedTrip?.totalYouOwe || 0) > 0
                }"
              >
                {{
                  selectedTrip?.totalYouOwe
                    | currency : 'PLN' : 'symbol' : '1.2-2'
                }}
              </div>
            </div>
            <div class="kpi">
              <div class="kpi__label">Owed to you</div>
              <div
                class="kpi__value"
                [ngClass]="{
                  positive: (selectedTrip?.totalOwedToYou || 0) > 0
                }"
              >
                {{
                  selectedTrip?.totalOwedToYou
                    | currency : 'PLN' : 'symbol' : '1.2-2'
                }}
              </div>
            </div>
          </div>

          <mat-divider></mat-divider>

          <div class="lists">
            <div class="list">
              <div class="list__title">
                <mat-icon>call_made</mat-icon>
                <span>You owe</span>
              </div>

              <div
                class="rows"
                *ngIf="
                  selectedTrip && selectedTrip.youOwe.length;
                  else noDebtsDetails
                "
              >
                <div class="row" *ngFor="let row of selectedTrip!.youOwe">
                  <span class="who">
                    <span class="who__name">{{ row.userName }}</span>
                    <span class="user-id-badge">{{ row.userId }}</span>
                  </span>
                  <span class="amount negative">
                    {{
                      row.amount
                        | currency : 'PLN' : 'symbol' : '1.2-2'
                    }}
                  </span>
                </div>
              </div>
            </div>

            <div class="list">
              <div class="list__title">
                <mat-icon>call_received</mat-icon>
                <span>Owe you</span>
              </div>

              <div
                class="rows"
                *ngIf="
                  selectedTrip && selectedTrip.owedToYou.length;
                  else noOneOwesDetails
                "
              >
                <div class="row" *ngFor="let row of selectedTrip!.owedToYou">
                  <span class="who">
                    <span class="who__name">{{ row.userName }}</span>
                    <span class="user-id-badge">{{ row.userId }}</span>
                  </span>
                  <span class="amount positive">
                    {{
                      row.amount
                        | currency : 'PLN' : 'symbol' : '1.2-2'
                    }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </mat-card>

        <ng-template #noDebtsDetails>
          <div class="muted">No debts</div>
        </ng-template>

        <ng-template #noOneOwesDetails>
          <div class="muted">No one owes you</div>
        </ng-template>
      </div>
    </ng-template>
  </ng-container>
</section>

<ng-template #loader>
  <div class="loader">Loading your expenses summary…</div>
</ng-template>

<ng-template #empty>
  <div class="empty">
    <h2>No trips yet</h2>
    <p>Create your first trip to start tracking shared expenses.</p>
  </div>
</ng-template>
